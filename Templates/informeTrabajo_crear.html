{% extends '_Layout.html' %}

{% block content %}
{% load static %}
<!--<link rel="stylesheet" href="{% static '/css/plugins/select2/select2.min.css' %}">
<link rel="stylesheet" href="{% static '/css/plugins/select2/select2-bootstrap4.min.css' %}">
-->

<link rel="stylesheet" href="{% static '/css/plugins/chosen/chosen.css' %}">




{% csrf_token %}
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
        

            <div class="col-lg-12">
                <div class="ibox " id="iboxTratos">
                    <div class="ibox-title">
                        <div class="row">
                            <div class="col-lg-3 col-12">
                                <h5><i class="fa fa-handshake-o fa-2x">&nbsp;&nbsp;</i>Informe de Trabajo </h5>
                            </div>
                            <div class="col-6" style="text-align: center;">
                                {% if itCabecera.idEstado.cod == "FIN" %}
                                <label style="color:#ce9446;font-size: 1.2rem; font-weight: bold;">FOLIO: {{itCabecera.folio}} {{itCabecera.idEstado.descripcion}}</label>
                                {% endif %}
                            </div>
                            <div class="col-3"></div>
                        </div>
                        
                        <input type="hidden" id="vmsj" value="{{mensaje}}" />
                    </div>
                    
                    <div class="ibox-content">
                        <div class="sk-spinner sk-spinner-wave">
                            <div class="sk-rect1"></div>
                            <div class="sk-rect2"></div>
                            <div class="sk-rect3"></div>
                            <div class="sk-rect4"></div>
                            <div class="sk-rect5"></div>
                        </div>
                        <div class="panel-group" id="accordion">
                            <div class="panel panel-default" >
                                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseOne"  style="cursor: pointer;" >
                                    <h5 class="panel-title">
                                        <a><i class="fa fa-file-text fa-2x" style="margin-right: 10px;width: 30px; text-align: center; color: #ce9446;"></i>CABECERA</a>
                                        <input type="hidden" id="hIdInforme" value="{{itCabecera.id}}" />
                                        <input type="hidden" id="hIdObra" value="{{itCabecera.obra.id}}" />
                                    </h5>
                                </div>
                                <div id="collapseOne" class="panel-collapse in collapse show">
                                    <div class="panel-body">
                                        <form id="frmCabecera">
                                            <div class="row">
                                                <div class="col-lg-3 col-12" style="padding-left:5px;padding-right: 5px;">
                                                    <medium>Obra:</medium>
                                                    <select id="selITobra" class="form-control" required>
                                                        {% for obras in obrasU %}
                                                            {% if obraSelect == obras.obra.id %}
                                                                <option value="{{obras.obra.id}}" selected>{{obras.obra.descripcion}}</option>
                                                            {% else %}
                                                                <option value="{{obras.obra.id}}">{{obras.obra.descripcion}}</option>
                                                            {% endif %}    
                                                        {% endfor %} 
                                                    </select>
                                                </div>
                                                
                                                <div class="col-lg-3 col-12" style="padding-left:5px;padding-right: 5px;">
                                                    <medium>Folio:</medium>
                                                        <input type="text" class="form-control" id="txtITfolio" style="text-transform:uppercase" value="{{itCabecera.folio}}" disabled="disabled" />
                                                </div>
                                                <div class="col-lg-3 col-6" style="padding-left:5px;padding-right: 5px;">
                                                    <medium>Fecha de Inicio:</medium>
                                                    <input type="date" class="form-control" style="text-transform:uppercase" id="txtITFechaInicio"  required value="{{ itCabecera.fechaInicio|date:"Y-m-d" }}" />
                                                </div>
                                                <div class="col-lg-3 col-6" style="padding-left:5px;padding-right: 5px;">
                                                    <medium>Fecha de Termino:</medium>
                                                    <input type="date" class="form-control" id="txtITFechaTermino" style="text-transform:uppercase" required value="{{ itCabecera.fechaTermino|date:"Y-m-d" }}" />
                                                </div>
                                            
                                            </div>   
                                            <div class="hr-line-dashed"></div>  
                                            <div class="row">
                                                <div class="col-lg-3 col-6">
                                                    <medium>Estado:</medium>
                                                        <input type="text" class="form-control" id="txtEstadoIt" style="text-transform:uppercase" value="{{itCabecera.idEstado.descripcion}}" disabled="disabled" />
                                                </div>
                                                <div class="col-lg-3 col-6">
                                                    <medium>Fecha Ingreso:</medium>
                                                        <input type="text" class="form-control" id="txtFechaIngresoIt" style="text-transform:uppercase" value="{{ itCabecera.fechaCreacion|date:"Y-m-d" }}" disabled="disabled" />
                                                </div>
                                                <div class="col-lg-3 col-6">
                                                    <medium>Fecha Finalizado:</medium>
                                                        <input type="text" class="form-control" id="txtFechaFinalizadoIt" style="text-transform:uppercase" value="{{ itCabecera.fechaFinalizado|date:"Y-m-d" }}" disabled="disabled" />
                                                </div>         
                                                <div class="col-lg-2 col-6" ></div>                                       
                                                <div class="col-lg-1 col-12" style="text-align: end;">
                                                    {% if itCabecera.idEstado.cod != "FIN" %}
                                                    <button type="submit" class="btn btn-sm btn-save"><i style="font-size: 1.2rem;" class="fa fa-floppy-o" aria-hidden="true"></i></button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-default" >
                                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" class="collapsed" style="cursor: pointer;">
                                    <h4 class="panel-title">
                                        <a><i class="fa fa-handshake-o fa-2x" style="margin-right: 10px;width: 30px; color: #ce9446;"></i>DETALLE REBAJE</a>
                                    </h4>
                                </div>
                                <div id="collapseTwo" class="panel-collapse collapse" >
                                    <div class="panel-body">
                                        <form id="frmDetalle">
                                            {% if itCabecera.idEstado.cod != "FIN" %}

                                            <div style="padding-top:5px;padding-bottom:5px;background-color: #f5f5f5; border: 1px solid #ce9446">
                                                <div class="row" style="margin-left: 0px;">
                                                    <div class="col-lg-1 col-12 d-flex align-items-center"><b><h3 style="text-align: center;">AGREGAR REBAJE</h3></b></div>
                                                    <div class="col-lg-9 col-12">
                                                        <div class="row">
                                                            <div class="col-lg-2 col-6 d-flex align-items-center" ><span class="align-middle">COD. TRATO:</span></div>
                                                            <div class="col-lg-2 col-6 d-flex align-items-center" ><input type="hidden" id="hValorTrato" value="0" />
                                                                <input type="text" class="form-control" id="txtITcodTrato" style="text-transform:uppercase" placeholder="" value="">
                                                            </div>
                                                            <div class="col-lg-8 col-12 d-flex align-items-center">
                                                                <b><span style="vertical-align: sub;" id="lblPartida">-</span> </b>
                                                                <div class="sk-spinner sk-spinner-three-bounce" id="loadingPartida" style="margin: 0px; display: none; height: 10px;">
                                                                    <div class="sk-bounce1"></div>
                                                                    <div class="sk-bounce2"></div>
                                                                    <div class="sk-bounce3"></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-lg-2 col-6 d-flex align-items-center" ><span class="align-middle">COD. UNIDAD:</span></div>                                          
                                                            <div class="col-lg-2 col-6" >
                                                                <input type="text" class="form-control" id="txtITcodUnidad" placeholder="" value="" data-toggle="popover" data-trigger="manual" data-placement="right" data-content="" style="text-transform:uppercase">
                                                            </div>
                                                            <div class="col-lg-2 col-6 d-flex align-items-center" >

                                                                <span class="align-middle col" style="padding:0px;">CANTIDAD:</span ><span id="spCantMax" style="font-size: 12px; display: none;">(disp.<span id="lblCantMax" style="padding:0px;"></span>)</span> 

                                                                <medium style="display: none;" id="lblMsjeUnidad">
                                                                    <b><medium id="lblTipoUnidad" style="display: none;">-</medium></b><b><medium id="lblmsjDisp" style="display: none;">-</medium> </b></medium><input type="hidden" id="unidadMedicion" value="" />    
                                                                <div class="sk-spinner sk-spinner-three-bounce" id="loadingTipoUnidad" style="margin: 0px; display: none; height: 10px">
                                                                    <div class="sk-bounce1"></div>
                                                                    <div class="sk-bounce2"></div>
                                                                    <div class="sk-bounce3"></div>
                                                                </div>
                                                            </div>  
                                                            <div class="col-lg-2 col-6 d-flex align-items-center" >
                                                                <input type="number" class="form-control" id="txtITcantidad" style="text-transform:uppercase" placeholder="0" value="">
                                                                
                                                            </div>
                                                            <div class="col-lg-2 col-6 d-flex align-items-center" style="text-align: center;"><span class="align-middle">% AVANCE:</span><span id="spAvanceMax" style="font-size: 12px; display: none;">  (disp: <span id="lblAvanceDisp" style="padding:0px;"></span>%)</span> </div>
                                                            <div class="col-lg-2 col-6 d-flex align-items-center" >
                                                                <input type="number" class="form-control" id="txtITporcentaje" placeholder="0" value="" min="1" max="100">
                                                                
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-12 d-flex align-items-center">
                                                        {% if itCabecera.idEstado.cod != "FIN" %}
                                                            <button type="button" class="btn btn-add" onclick="rebajeAgregar()" id="btnAddRebaje" ><i class="fa fa-plus fa-1x"></i></button>
                                                        {% endif %}

                                                        <label id="msjeRebaje" style="margin-left: 10px;"></label>
                                                    </div>

                                                </div>
                                            </div>

                                            
                                            <br />                                          
                                            
                                       
                                            {% endif %}
                                            <h4>Rebajes Informe de trabajo</h4>
                                            <div class="row">
                                                <div class="table-responsive" style="overflow: auto; height:auto;margin-left: 20px; margin-right: 20px;">
                                                    <table class="table table-bordered table-hover dataTables-example dataTable" id="tbRebajeTrato">
                                                    <thead style="position: sticky;top:0;background-color: white;">
                                                    <tr role="row">
                                                        <th style="width: 10%;">Cod. Trato</th>
                                                        <th >Partida</th>
                                                        <th style="width: 10%;">Cod. Unidad</th>
                                                        <th >Tipo Unidad</th>
                                                        <th style="width: 10%;">Cantidad</th>
                                                        <th style="width: 10%;">% de Avance</th>
                                                        <th style="width: 10%;">Valor Trato</th>
                                                        <th style="width: 10%;">Total a pagar</th>
                                                        <th style="width: 10%;">Observación</th>
                                                        {% if itCabecera.idEstado.cod != "FIN" %}
                                                        <th style="width: 7%; text-align:center"></th>
                                                        {% endif %}
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% if idDetalle|length > 0 %}
                                                            {% for dInforme in idDetalle %}
                                                           
                                                                <tr id='row_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}'>
                                                                    <td><input type="text" id="codTrato_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}" class="form-control dd" value="{{dInforme.trato.cod}}" disabled /></td>
                                                                    <td style="vertical-align: middle;">{{dInforme.trato.partida}}</td>
                                                                    <td><input type="text" id="codUnidad_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}" class="form-control" value="{{dInforme.unidad.cod}}" disabled /></td>
                                                                    <td style="vertical-align: middle;">{{dInforme.unidad.idModelo.tipo.descripcion}}</td>
                                                                    <td><input type="text" id="cantidad_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}" class="form-control ec" value="{{dInforme.cantidad}}" disabled /></td>
                                                                    <td><input type="number" id="avance_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}" class="form-control ea" value="{{dInforme.avance}}" disabled /></td>
                                                                    <td style="vertical-align: middle;"><label id="valorTrato_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}" style="margin: 0px;">{{ dInforme.obtener_valor_trato_modelo }}</label></td>
                                                                    <td style="vertical-align: middle;"><label id="aPagar_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}" style="margin: 0px;">{{dInforme.valor_sep}}</label></td>
                                                                    <td><medium style="color: red;" class="cmsje" id="cmsje_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}"></medium><medium style="color: red;" class="smsje" id="smsje_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}"></medium></td>
                                                                    {% if itCabecera.idEstado.cod != "FIN" %}
                                                                    <td style='vertical-align:middle;text-align:center'>
                                                                        <i class="fa fa-edit" onclick="editTr(this,'{{dInforme.unidad.idModelo.tipo.medicion}}')" aria-hidden="true"></i> | <i class="fa fa-minus-circle" style="cursor:pointer" onclick="removeTr(this,{{dInforme.id}},'d')" aria-hidden="true"></i>
                                                                    </td>
                                                                    {% endif %}
                                                                    <td style="display: none;">
                                                                            <input type="hidden" class="vRebaje" id="informe_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}" name="hIdDInforme_{{dInforme.id}}" value="{{dInforme.id}}" />
                                                                            <input type="hidden" id="rMedicion_{{dInforme.trato.cod}}_{{dInforme.unidad.cod}}" name="rMedicion_{{dInforme.id}}" value="{{dInforme.unidad.idModelo.tipo.medicion}}" />
                                                                    </td>
                                                                </tr>
                                                            {% endfor %} 
                                                        {% else %}
                                                            <tr id="trItvacio"><td colspan="10" style="text-align:center">Ingrese rebaje(s) de trato(s).</td></tr>
                                                        {% endif %}
                                                    </tbody>
            
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="hr-line-dashed"></div>  
                                            <div class="row">
                                                <div class="col-11">

                                                </div>
                                                
                                                <div class="col-1" style="text-align: end;">
                                                    {% if itCabecera.idEstado.cod != "FIN" %}
                                                    <button type="submit" class="btn btn-sm btn-save"><i style="font-size: 1.2rem;" class="fa fa-floppy-o" aria-hidden="true"></i></button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-default">
                                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" class="collapsed" style="cursor: pointer;">
                                    <h4 class="panel-title">
                                        <a><i class="fa fa-users fa-2x" style="margin-right: 10px;width: 30px; color: #ce9446;"></i>DETALLE CUADRILLA</a>
                                    </h4>
                                </div>
                                <div id="collapseThree" class="panel-collapse collapse" >
                                    <div class="panel-body">
                                        <form id="frmCuadrilla">
                                            {% if itCabecera.idEstado.cod != "FIN" %}
                                            <div class="hr-line-dashed" style="margin-top: 3px;"></div>
                                            <div class="row" style="padding-top:5px">
                                                
                                                <div class="col-lg-2 col-xs-12" style="padding-left:5px;padding-right: 5px;">
                                                    <medium>Cod. Talana:</medium>
                                                    <input type="text" class="form-control" id="txtCodTalana" style="text-transform: uppercase;" placeholder="Cod. Talana" value="">
                                                    
                                                </div>
                                                
                                                <div class="col-lg-2 col-xs-12" style="padding-left:5px;padding-right: 5px;">
                                                    <medium>Nombre Trabajador:</medium>
                                                    <input type="text" class="form-control" id="txtNombreTrabajador" style="text-transform: uppercase;" placeholder="Nombre Trabajador" value="">
                                                </div>
            
                                                <div class="col-lg-3 col-xs-12" style="padding-left:5px;padding-right: 5px; text-align: center;">
                                                    <fieldset>
                                                        <p style="margin-bottom: 0px;">
                                                            Días trabajados
                                                        </p>
                                                        <div class="form-check abc-checkbox form-check-inline">
                                                            <input class="form-check-input" type="checkbox" id="checkTRlunes">
                                                            <label class="form-check-label" for="checkTRlunes"> L </label>
                                                        </div>
                                                        <div class="form-check abc-checkbox abc-checkbox-success form-check-inline">
                                                            <input class="form-check-input" type="checkbox" id="checkTRmartes">
                                                            <label class="form-check-label" for="checkTRmartes"> M </label>
                                                        </div>
                                                        <div class="form-check abc-checkbox form-check-inline">
                                                            <input class="form-check-input" type="checkbox" id="checkTRmiercoles">
                                                            <label class="form-check-label" for="checkTRmiercoles"> Mi </label>
                                                        </div>
                                                        <div class="form-check abc-checkbox form-check-inline">
                                                            <input class="form-check-input" type="checkbox" id="checkTRjueves">
                                                            <label class="form-check-label" for="checkTRjueves"> J </label>
                                                        </div>
                                                        <div class="form-check abc-checkbox form-check-inline">
                                                            <input class="form-check-input" type="checkbox" id="checkTRviernes">
                                                            <label class="form-check-label" for="checkTRviernes"> V </label>
                                                        </div>
                                                    </fieldset> 
                                                </div>
                                                <div class="col-lg-2 col-xs-12" style="padding-left:5px;padding-right: 5px;">
                                                    <medium>Total días:</medium>
                                                    <input type="number" class="form-control" id="txtTotalDias" style="text-transform:uppercase" placeholder="Total Días" value="">
                                                </div>   
                                                <div class="col-lg-2 col-xs-12" style="padding-left:5px;padding-right: 5px;">
                                                    <medium>Valor día($):</medium>
                                                    <input type="number" class="form-control" id="txtValorDia" style="text-transform:uppercase" placeholder="Valor día ($)" value="">
                                                </div> 
                              
                                                <div class="col-lg-1 col-xs-12" style="text-align: end; margin-top: 5px;">
                                                    <button type="button" class="btn btn-add" onclick="cuadrillaAgregar()" style="text-align: end;"><i class="fa fa-plus fa-1x" aria-hidden="true"></i></button>
                                                </div>
                                            
                                            </div>
                                           
                                            <div class="hr-line-dashed"></div>  
                                            {% endif %}
                                            <div class="row">
                                                <div class="table-responsive" style="overflow: auto; height:auto; margin-left: 20px; margin-right: 20px">
                                                    <table class="table table-bordered table-hover dataTables-example dataTable" id="tbCuadrillaTrato">
                                                    <thead style="position: sticky;top:0;background-color: white;">
                                                    <tr role="row">
                                                        <th colspan="2" style="background-color: white;border-color: white;"></th>
                                                        <th colspan="5" style="text-align: center;">Días trabajados</th>
                                                        <th colspan="4" style="background-color: white;border-color: white;"></th>
                                                    </tr>                                        
                                                    <tr role="row">
                                                        <th>Cod. Talana</th>
                                                        <th >Nombre Trabajador</th>
                                                        <th>L</th>
                                                        <th>M</th>
                                                        <th>Mi</th>
                                                        <th>J</th>
                                                        <th>V</th>
                                                        <th >Total días</th>
                                                        <th>Valor día</th>
                                                        <th>Total</th>
                                                        {% if itCabecera.idEstado.cod != "FIN" %}
                                                        <th style="width: 7%; text-align:center"></th>
                                                        {% endif %}
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% if iCuadrilla|length > 0 %}
                                                            {% for cuadrilla in iCuadrilla %}
                                                                <tr>
                                                                    <td><input type="text" class="form-control dd" value="{{cuadrilla.codTalana}}" disabled /></td>
                                                                    <td><input type="text" class="form-control" value="{{cuadrilla.nomTrab}}" disabled /></td>

                                                                    {% if cuadrilla.lunTrab %}
                                                                        <td><input type="checkbox" checked disabled /></td>
                                                                    {% else %}
                                                                        <td><input type="checkbox" disabled /></td>
                                                                    {% endif %}
                                                                    {% if cuadrilla.marTrab %}
                                                                        <td><input type="checkbox" checked disabled /></td>
                                                                    {% else %}
                                                                        <td><input type="checkbox" disabled /></td>
                                                                    {% endif %}
                                                                    {% if cuadrilla.mieTrab == True %}
                                                                        <td><input type="checkbox" checked disabled /></td>
                                                                    {% else %}
                                                                        <td><input type="checkbox" disabled /></td>
                                                                    {% endif %}
                                                                    {% if cuadrilla.jueTrab %}
                                                                        <td><input type="checkbox" checked disabled /></td>
                                                                    {% else %}
                                                                        <td><input type="checkbox" disabled /></td>
                                                                    {% endif %}
                                                                    {% if cuadrilla.vieTrab %}
                                                                        <td><input type="checkbox" checked disabled /></td>
                                                                    {% else %}
                                                                        <td><input type="checkbox" disabled /></td>
                                                                    {% endif %}

                                                                    <td><input type="text" class="form-control" value="{{cuadrilla.totalDias}}" disabled /></td>
                                                                    <td><input type="text" class="form-control" value="{{cuadrilla.valorDia}}" disabled /></td>
                                                                    <td><input type="text" class="form-control" value="{{cuadrilla.total}}" disabled /></td>
                                                                    {% if itCabecera.idEstado.cod != "FIN" %}
                                                                    <td style='vertical-align:middle;text-align:center'>
                                                                        <i class="fa fa-edit" onclick="editTr(this,'CUA')" aria-hidden="true"></i> | <i class="fa fa-minus-circle" style="cursor:pointer" onclick="removeTr(this,{{cuadrilla.id}},'c')" aria-hidden="true"></i>
                                                                    </td>
                                                                    {% endif %}
                                                                    <td style="display: none;"><input type="hidden" name="hIdCInforme_{{cuadrilla.id}}" value="{{cuadrilla.id}}" /></td>
                                                                </tr>
                                                            {% endfor %} 
                                                        {% else %}
                                                            <tr id="trItcVacio"><td colspan="11" style="text-align:center">Ingrese trabajador(es) de la cuadrilla.</td></tr>
                                                        {% endif %}
                                                        
                                                    </tbody>
            
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="hr-line-dashed"></div>  
                                            <div class="row">
                                                <div class="col-11">

                                                </div>
                                                
                                                <div class="col-1" style="text-align: end;">
                                                    {% if itCabecera.idEstado.cod != "FIN" %}
                                                    <button type="submit" class="btn btn-sm btn-save"><i style="font-size: 1.2rem;" class="fa fa-floppy-o" aria-hidden="true"></i></button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            {% load humanize %}
                        <div class="hr-line-dashed"></div>  
                        <div class="row">
                            <div class="col-lg-3 col-xs-12"></div>
                            <div class="col-lg-3 col-xs-12" style="text-align: end;">
                                <h3>TOTAL REBAJES ($) </h3><h3 id="hTotalRebajes">{{ totalRebaje|floatformat:0|intcomma }}</h3>
                            </div>
                            <div class="col-lg-3 col-xs-12" style="text-align: end;">
                                <h3>TOTAL CUADRILLA ($)</h3><h3 id="hTotalCuadrilla">{{ totalCuadrilla|floatformat:0|intcomma }}</h3>
                            </div>
                            <div class="col-lg-3 col-xs-12" style="text-align: end;">
                                {% if itCabecera.idEstado.cod != "FIN" %}
                                <input type="button" class="form-control btn btn-sm btn-primary" id="btnFinalizarInforme" onclick="finalizar_informe(this)" value="Finalizar Informe" />
                                {% endif %}
                            </div>
                        </div> 
                                              
                        </div>

                    </div>
                </div>
            </div>
 
        </div>
    
    </div>


    {% if itCabecera.idEstado.cod != "FIN" %}
    <style>
        .bs-popover-right > .arrow::after{
            border-right-color: red!important;
        }
    </style>
    <!--<script src="{% static 'js/plugins/select2/select2.full.min.js' %}"></script>-->
    <script src="{% static 'js/plugins/chosen/chosen.jquery.js' %}"></script>
    <script>

        $("#frmCabecera").on("submit", function( event ) {
            guardar_cabecera();
            return false;
        });

        $("#frmDetalle").on("submit", function( event ) {
            guardar_detalle();
            return false;
        });

        $("#frmCuadrilla").on("submit", function( event ) {
            guardar_cuadrilla();
            return false;
        });

        $("#txtITcantidad").blur(function(){
            //calculaAvanceCant();
        });

        $(".ea").change(function(){
            let id = this.id;
            let tr = id.split("_")[1];
            let uni = id.split("_")[2];

            let total = parseFloat(($("#valorTrato_"+tr+"_"+uni).html()=="")?"0":$("#valorTrato_"+tr+"_"+uni).html().replaceAll(",",""));
            let porcentaje = parseFloat(this.value.replaceAll(",",""));

            aPagar = (porcentaje*total)/100;
            $("#aPagar_"+tr+"_"+uni).html(Intl.NumberFormat("es-MX").format(aPagar));

        });

        function guardar_cabecera()
        {
            let vObra  = $("#selITobra").val();
            let vFolio  = $("#txtITfolio").val();
            let vFechaInicio  = $("#txtITFechaInicio").val();
            let vFechatermino  = $("#txtITFechaTermino").val();
            let vIdInforme = $("#hIdInforme").val();

            if(vObra != "" && vFechaInicio != "" && vFechatermino  != ""){
                let data = new FormData();
                data.append('idObra',vObra);
                data.append('vFolio',vFolio);
                data.append('vFechaInicio',vFechaInicio);
                data.append('vFechatermino',vFechatermino);
                data.append('vIdInforme',vIdInforme);
                data.append('csrfmiddlewaretoken',$("input[name=csrfmiddlewaretoken]").val());


                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                fetchS("{% url 'informeTrabajo_cabecera_guardar' %}",{method:'POST',body: data})
                .then((response) =>  response.json())
                .then((data) => {
                    if(data.msj=="OK"){
                        showToast("Exito","Registro guardado","Cabecera de informe de trabajo guardada.")
                        $("#txtFechaIngresoIt").val(data.fechaIngreso);
                        $("#hIdInforme").val(data.id);
                        $("#hIdObra").val(vObra);
                        $("#txtITfolio").val(data.folio);
                        $("#txtEstadoIt").val("Ingresado");
                    }
                    else{
                        if(data.folio == "rep")
                        {
                            showToast("Error","Error","Este folio ya se encuentra ingresado en otro informe de trabajo.")
                        }
                        else
                        {
                            showToast("Error","Error","Comuniquese con un administrador.")
                        }
                    }
                    $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                })
                .catch(function(error){console.log(error);$('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');showToast('Error','Error','Ocurrió un error o no tiene autorización, comuniquese con Soporte.');});
            }
        }

        function guardar_detalle()
        {
            $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
            let vidInforme  = $("#hIdInforme").val();
            let vidObra  = $("#hIdObra").val();
            $(".smsje").html("");
            $(".cmsje").html("");
            $(".ed").removeAttr("style");
            if(vidInforme != "" ){

                let rData = "";
                $("#trItvacio").remove();
                let tb = $("#tbRebajeTrato tbody");
                let err = 0;
                $(tb).find('tr').each (function() {
                    codTrato = this.children[0].childNodes[0].value;
                    codUnidad = this.children[2].childNodes[0].value;
                    cantidad = this.children[4].childNodes[0].value;
                    porcentaje = this.children[5].childNodes[0].value;
                    valorTrato = this.children[6].childNodes[0].innerHTML;
                    totalPagar = this.children[7].childNodes[0].innerHTML;
                    idReg = $("#informe_"+codTrato+"_"+codUnidad).val();
                    medicion = $("#rMedicion_"+codTrato+"_"+codUnidad).val();

                    if(codTrato != "" && codUnidad != "" && cantidad > 0 && porcentaje > 0)
                    {
                        rData += '{"codTrato":"'+codTrato+'","codUnidad":"'+codUnidad+'","cantidad":"'+cantidad+'","porcentaje":"'+porcentaje+'","id":"'+idReg+'","med":"'+medicion+'"},'
                    }
                    else
                    {
                        err = 1;
                        return false;
                    }

                });  

                if(err == 0){
                
                    let data = new FormData();
                    data.append('idInforme',vidInforme);
                    data.append('idObra',vidObra);
                    data.append('data',"["+rData.substring(0,rData.length - 1)+"]");
                    data.append('csrfmiddlewaretoken',$("input[name=csrfmiddlewaretoken]").val());


                    
                    fetchS("{% url 'informeTrabajo_detalle_guardar' %}",{method:'POST',body: data})
                    .then((response) =>  response.json())
                    .then((data) => {
                        if(data.msj == "[]"){
                            if(data.id != ""){
                                $('.vRebaje').each(function() {
                                    if ($(this).val() === '0') {
                                        $(this).val('P');
                                    }
                                });
                                showToast("Exito","Registro guardado","Detalle rebaje(s) de informe de trabajo guardado.")
                                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                                $("#hTotalRebajes").html(Intl.NumberFormat("es-MX").format(data.sumTotal));
                                $("#txtITcantidad").val("");
                                $("#txtITporcentaje").val("");
                                $("#txtITcodTrato").val("");
                                $("#txtITcodUnidad").val("");
                            }
                        }
                        else
                        {
                            let arrMsj =  JSON.parse(data.msj);

                            $.each(arrMsj, function(i, item) {
                                let msjeError = "";
                                if(item.medicion =="uni"){

                                    $("#avance_"+item.trato).css("border-color","red");
                                    $("#smsje_"+item.trato+"_"+item.unidad).html("Rebaje en folio:"+item.folio+"|| disp:"+item.disp);

                                }
                                if(item.medicion=="can"){

                                    $("#cantidad_"+item.trato).css("border-color","red");
                                    msjeError = (item.folio != "" && item.folio != undefined)?"R. Folio:"+item.folio+"||disp:"+item.disp:"CantMax:"+item.max;    
                                    $("#cmsje_"+item.trato+"_"+item.unidad).html(msjeError);

                                }
                            });
                            showToast("Error","Error","Verifique los % de avance y/o cantidad. No pueden superar el máximo.")
                            $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                        }
                    })
                    .catch(function(error){console.log(error);$('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');showToast('Error','Error','Ocurrió un error o no tiene autorización, comuniquese con Soporte.');});
                    
                }
                else
                {
                    //error
                    $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                }
            }else{
                //error
                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
            }
        }

        function guardar_cuadrilla()
        {
            $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
            let vidInforme  = $("#hIdInforme").val();
            let vidObra  = $("#hIdObra").val();
        
            if(vidInforme != "" ){

                let rData = "";
                $("#trItcVacio").remove();
                let tb = $("#tbCuadrillaTrato tbody");
                let err = 0;
                $(tb).find('tr').each (function() {
                    codTalana = this.children[0].childNodes[0].value;
                    nomtrab = this.children[1].childNodes[0].value;
                    luntrab = (this.children[2].childNodes[0].checked)?"1":"0";
                    martrab = (this.children[3].childNodes[0].checked)?"1":"0";
                    mietrab = (this.children[4].childNodes[0].checked)?"1":"0";
                    juetrab = (this.children[5].childNodes[0].checked)?"1":"0";
                    vietrab = (this.children[6].childNodes[0].checked)?"1":"0";
                    totalDias = this.children[7].childNodes[0].value;
                    valorDia = this.children[8].childNodes[0].value;
                    total = this.children[9].childNodes[0].value;
                    idReg = this.children[11].childNodes[0].value;
                    

                    if(codTalana != "" && nomtrab != "" && luntrab != "" && martrab != "" && mietrab != "" && juetrab != "" && vietrab != "" && totalDias != "" && valorDia != "" && total != "") 
                    {
                        rData += '{"codTalana":"'+codTalana+'","nomtrab":"'+nomtrab+'","luntrab":"'+luntrab+
                                '","martrab":"'+martrab+'","mietrab":"'+mietrab+'","juetrab":"'+juetrab+'","vietrab":"'+vietrab+
                                '","totalDias":"'+totalDias+'","valorDia":"'+valorDia+'","total":"'+total+'","id":"'+idReg+'"},'
                    }
                    else
                    {
                        err = 1;
                        return false;
                    }

                });  

                if(err == 0){
                
                    let data = new FormData();
                    data.append('idInforme',vidInforme);
                    data.append('idObra',vidObra);
                    data.append('data',"["+rData.substring(0,rData.length - 1)+"]");
                    data.append('csrfmiddlewaretoken',$("input[name=csrfmiddlewaretoken]").val());


                    
                    fetchS("{% url 'informeTrabajo_cuadrilla_guardar' %}",{method:'POST',body: data})
                    .then((response) =>  response.json())
                    .then((data) => {
                        if(data.id>0){
                            $("#hTotalCuadrilla").html(Intl.NumberFormat("es-MX").format(data.totalCuadrilla));
                            showToast("Exito","Registro guardado","Detalle cuadrilla de informe de trabajo guardado.")
                            $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                        }
                    })
                    .catch(function(error){console.log(error);$('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');showToast('Error','Error','Ocurrió un error o no tiene autorización, comuniquese con Soporte.');});
                    
                }
                else
                {
                    //error
                    $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                }
            }else{
                //error
                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
            }
        }

        function eliminar_detalle(id)
        {
            $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
            if(id != "" ){
                let data = new FormData();
                data.append('idInforme',id);
                data.append('csrfmiddlewaretoken',$("input[name=csrfmiddlewaretoken]").val());
                fetchS("{% url 'informeTrabajo_detalle_eliminar' %}",{method:'POST',body: data})
                .then((response) =>  response.json())
                .then((data) => {
                    if(data.id>0){
                        let vTotalRebajes = ($("#hTotalRebajes").html().replaceAll(',','') != "")?$("#hTotalRebajes").html().replaceAll(',',''):"0";
                        let totalRebajes = parseInt(vTotalRebajes);
                        let totalDetalle = parseInt(data.totalDetalle);

                        totalRebajes = totalRebajes-totalDetalle;
                        $("#hTotalRebajes").html(Intl.NumberFormat("es-MX").format(totalRebajes));

                        showToast("Exito","Registro eliminado","Detalle de informe de trabajo eliminado.")
                        $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                    }
                })
                .catch(function(error){console.log(error);$('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');showToast('Error','Error','Ocurrió un error o no tiene autorización, comuniquese con Soporte.');});
                

            }else{
                //error
                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
            }
        }

        function eliminar_cuadrilla(id)
        {
            $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
            if(id != "" ){
                let data = new FormData();
                data.append('idInforme',id);
                data.append('csrfmiddlewaretoken',$("input[name=csrfmiddlewaretoken]").val());
                fetchS("{% url 'informeTrabajo_cuadrilla_eliminar' %}",{method:'POST',body: data})
                .then((response) =>  response.json())
                .then((data) => {
                    if(data.id>0){
                        $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                        showToast("Exito","Registro eliminado","trabajador de cuadrilla de informe de trabajo eliminado.")
                       
                        let vTotalCuadrilla = ($("#hTotalCuadrilla").html().replaceAll(',','') != "")?$("#hTotalCuadrilla").html().replaceAll(',',''):"0";
                        let totalCuadrilla = parseInt(vTotalCuadrilla);
                        let totalDetalle = parseInt(data.total);

                        totalCuadrilla = totalCuadrilla-totalDetalle;
                        $("#hTotalCuadrilla").html(Intl.NumberFormat("es-MX").format(totalCuadrilla));
                    }
                })
                .catch(function(error){console.log(error);$('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');showToast('Error','Error','Ocurrió un error o no tiene autorización, comuniquese con Soporte.');});
                

            }else{
                //error
                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
            }
        }

        function rebajeAgregar(){

            let codTrato = $("#txtITcodTrato").val();
            let codUnidad = $("#txtITcodUnidad").val().toUpperCase();
            let cantidad = $("#txtITcantidad").val();
            let porcentaje = $("#txtITporcentaje").val();
            let partida = $("#lblPartida").html();
            let tipoUnidad = $("#lblTipoUnidad").html();
            let avanceDisp = $("#lblAvanceDisp").html();
            let cantDisp = $("#lblCantMax").html();
            let unidadMedicion = $("#unidadMedicion").val();
            let valorTrato = ($("#hValorTrato").val() == "")?"0":$("#hValorTrato").val();
            let arr = true;

            if(unidadMedicion == "UNI" && parseFloat(porcentaje) > parseFloat(avanceDisp)){
                showToast("Error","Error!","El avance ingresado no puede ser mayor al disponible.");
                arr = false;
            }
            else if(unidadMedicion == "CAN" && parseFloat(cantidad) > parseFloat(avanceDisp))
            {
                showToast("Error","Error!","La cantidad ingresada no puede ser mayor al disponible.");
                arr = false;
            }

            if(arr)
            {
                //inputUnidad = $("#tbRebajeTrato tbody tr").find("input[value='"+codUnidad+"']");
                inputUnidad = $("#row_"+codTrato.toUpperCase()+"_"+codUnidad.toUpperCase()).attr("id");
                if(inputUnidad == undefined)
                {

                    if(cantidad != "" && porcentaje != ""){
                        if(parseInt(cantidad)>0 && parseInt(porcentaje)>0){
                            let aPago = parseInt(valorTrato)*parseInt(porcentaje)/100;
                            let row = "<tr id='row_"+codTrato.toUpperCase()+"_"+codUnidad.toUpperCase()+"'>"+
                                        "<td><input type='text' class='form-control dd' id='codTrato_"+codTrato.toUpperCase()+"_"+codUnidad+"' disabled='disabled' value='"+codTrato.toUpperCase()+"' /> </td>"+
                                        "<td style='vertical-align:middle'><label>"+partida+"</label></td>"+
                                        "<td><input type='text' class='form-control' id='codUnidad_"+codTrato.toUpperCase()+"_"+codUnidad+"' disabled='disabled' value='"+codUnidad.toUpperCase()+"' /> </td>"+
                                        "<td style='vertical-align:bottom'><label>"+tipoUnidad+"</label></td>"+
                                        "<td><input type='text' class='form-control ec' id='cantidad_"+codTrato.toUpperCase()+"_"+codUnidad+"' disabled='disabled' value='"+cantidad.toUpperCase()+"' /></td>"+
                                        "<td><input type='number' class='form-control ea' id='avance_"+codTrato.toUpperCase()+"_"+codUnidad+"'  disabled='disabled' value='"+porcentaje.toUpperCase()+"' /> </td>"+
                                        "<td id='valorTrato_"+codTrato.toUpperCase()+"_"+codUnidad+"'>"+Intl.NumberFormat("es-MX").format(valorTrato)+"</td>"+
                                        "<td id='aPagar_"+codTrato.toUpperCase()+"_"+codUnidad+"'>"+Intl.NumberFormat("es-MX").format(aPago)+"</td>"+
                                        "<td><medium style='color: red;' class='cmsje' id='cmsje_"+codTrato.toUpperCase()+"_"+codUnidad+"'></medium><medium style='color: red;' class='smsje' id='smsje_"+codTrato.toUpperCase()+"_"+codUnidad+"'></medium></td>"+
                                        "<td style='vertical-align:middle;text-align:center'><i class='fa fa-edit' onclick='editTr(this,\""+unidadMedicion+"\")'></i> | <i class='fa fa-minus-circle' style='cursor:pointer' onclick='removeTr(this,0,\"d\")'></i>"+
                                        "<td style='display: none;''><input type='hidden' class='vRebaje' id='informe_"+codTrato.toUpperCase()+"_"+codUnidad+"' value='0'>"+
                                        '<input type="hidden" id="rMedicion_'+codTrato.toUpperCase()+'_'+codUnidad+'" name="rMedicion_{{dInforme.id}}" value="'+unidadMedicion+'" />'
                                        "</td>"+
                                        "</tr>";

                            $("#tbRebajeTrato tbody").append(row);
                            $("#trItvacio").remove();
                            $("#txtITcodTrato").val('');
                            $("#txtITcodUnidad").val('');
                            $("#txtITcantidad").val('');
                            $("#txtITporcentaje").val('');
                            $("#lblTipoUnidad").html('-');
                            $("#lblAvanceDisp").html('-')
                            $("#txtITcantidad").prop("disabled",false);
                            $("#spCantMax").hide();
                            $("#spAvanceMax").hide();  
                            $("#msjeRebaje").html("");
                        }
                        else
                        {
                            showToast("Error","Error!","cantidad y porcentaje debe ser mayor a 0.")
                        }
                    }
                    else
                    {
                        showToast("Error","Error!","cantidad y porcentaje debe ser mayor a 0.")
                    }
                }
                else
                {
                    showToast("Error","Error!","Ya se a gregó un rebaje para el trato/unidad ingresado.")
                }
            }

        };

        function cuadrillaAgregar()
        {
            let codTalana = $("#txtCodTalana").val();
            let nombreTrabajador = $("#txtNombreTrabajador").val().toUpperCase();
            let lunesTr = ($("#checkTRlunes").is(":checked"))?"checked":"";
            let martesTr = ($("#checkTRmartes").is(":checked"))?"checked":"";
            let miercolesTr = ($("#checkTRmiercoles").is(":checked"))?"checked":"";
            let juevesTr = ($("#checkTRjueves").is(":checked"))?"checked":"";
            let viernesTr = ($("#checkTRviernes").is(":checked"))?"checked":"";
            let valorDia = $("#txtValorDia").val();
            let totalDia = $("#txtTotalDias").val();

            lunesTr = '<input type="checkbox" id="checkTRl" '+lunesTr+' />';
            martesTr = '<input type="checkbox" id="checkTRm" '+martesTr+' />';
            miercolesTr = '<input type="checkbox" id="checkTRmi" '+miercolesTr+' />';
            juevesTr = '<input type="checkbox" id="checkTRj" '+juevesTr+' />';
            viernesTr = '<input type="checkbox" id="checkTRv" '+viernesTr+' />';


            let total = parseInt(valorDia)*parseInt(totalDia);
            let row = "<tr>"+
                        "<td><input type='text' class='form-control dd' disabled='disabled' value='"+codTalana.toUpperCase()+"' /> </td>"+
                        "<td><input type='text' class='form-control' disabled='disabled' value='"+nombreTrabajador.toUpperCase()+"' /></td>"+
                        "<td style='vertical-align:bottom; text-align:center'>"+lunesTr+"</td>"+
                        "<td style='vertical-align:bottom; text-align:center'>"+martesTr+"</td>"+
                        "<td style='vertical-align:bottom; text-align:center'>"+miercolesTr+"</td>"+
                        "<td style='vertical-align:bottom; text-align:center'>"+juevesTr+"</td>"+
                        "<td style='vertical-align:bottom; text-align:center'>"+viernesTr+"</td>"+
                        "<td><input type='text' class='form-control' disabled='disabled' value='"+totalDia+"' /></td>"+
                        "<td><input type='text' class='form-control' disabled='disabled' value='"+valorDia+"' /> </td>"+
                        "<td><input type='text' class='form-control' disabled='disabled' value='"+total+"' /> </td>"+
                        "<td style='vertical-align:middle;text-align:center'><i class='fa fa-edit' onclick='editTr(this,\"CUA\")'></i> | <i class='fa fa-minus-circle' style='cursor:pointer' onclick='removeTr(this,0,\"c\")'></i></td>"+
                        "<td style='display: none;''><input type='hidden' value='0'></td>"+
                        "</tr>";

            $("#tbCuadrillaTrato tbody").append(row);
            $("#trItvacio").remove();
            $("#txtCodTalana").val('');
            $("#txtNombreTrabajador").val('');
            $('#checkTRlunes').prop('checked', false);
            $('#checkTRmartes').prop('checked', false);
            $('#checkTRmiercoles').prop('checked', false);
            $('#checkTRjueves').prop('checked', false);
            $('#checkTRviernes').prop('checked', false);
            $("#txtValorDia").val('');
            $("#txtTotalDias").val('');
            
        }
        $("#txtITcodTrato").change(function(){
            obtenerPartida();
        });
        $("#txtITcodUnidad").change(function(){
            obtenerTipoUnidad();
        });
        function obtenerPartida()
        {
            let data = new FormData();
            let codTrato = $("#txtITcodTrato").val();
            $("#txtITcodUnidad").popover("hide");
            $("#txtITcodTrato").popover("hide");
            $("#spCantMax").hide();
            $("#spAvanceMax").hide();
            $("#txtITcodUnidad").val("");
            $("#lblTipoUnidad").html("-");
            $("#lblmsjDisp").html("");
            $("#txtITcantidad").val("");
            $("#txtITporcentaje").val("");

            data.append('idObra',$("#selITobra").val());
            data.append('codTrato',codTrato.toUpperCase());
            data.append('csrfmiddlewaretoken',$("input[name=csrfmiddlewaretoken]").val());
            $("#loadingPartida").show();
            $("#lblPartida").hide();
            fetchS("{% url 'trato_partida_obtener' %}",{method:'POST',body: data})
            .then((response) =>  response.json())
            .then((data) => {

                if(data.v == 1){
                    $("#loadingPartida").hide();
                    $("#lblPartida").html(data.partida);
                    $("#lblPartida").show();
                    //$("#lblCantMax").html(data.max);
                    $("#btnAddRebaje").removeAttr("disabled");
                    $("#txtITcodUnidad").removeAttr("disabled");
                }else
                {
                    $("#loadingPartida").hide();
                    popover_err("txtITcodTrato",data.partida); 
                    $("#btnAddRebaje").attr("disabled","disabled");
                    $("#txtITcodUnidad").attr("disabled","disabled");
                }
            })
            .catch(function(error){console.log(error);showToast('Error','Error','Ocurrió un error o no tiene autorización, comuniquese con Soporte.');});
        }
        
        function obtenerTipoUnidad()
        {
            $("#txtITcodUnidad").popover("hide");
            $("#txtITcantidad").val('');
            $("#txtITcantidad").prop("disabled",false);
            $("#txtITcantidad").val("");
            $("#txtITporcentaje").val("");
            let data = new FormData();
            let codUnidad = $("#txtITcodUnidad").val();
            let codTrato = $("#txtITcodTrato").val();
            let vidInforme  = $("#hIdInforme").val();
            data.append('idObra',$("#selITobra").val());
            data.append('codUnidad',codUnidad.toUpperCase());
            data.append('codTrato',codTrato.toUpperCase());
            data.append('idInforme',vidInforme);
            data.append('csrfmiddlewaretoken',$("input[name=csrfmiddlewaretoken]").val());
            $("#loadingTipoUnidad").show();
            $("#lblMsjeUnidad").hide();
            fetchS("{% url 'unidadObra_tipo_obtener' %}",{method:'POST',body: data})
            .then((response) =>  response.json())
            .then((data) => {
                $("#loadingTipoUnidad").hide();
                $("#lblTipoUnidad").html(data.tipoUnidad);
                let codTrato = $("#txtITcodTrato").val().toUpperCase();
                let nAvance = $("#avance_"+codTrato).val();
                let informe = $("#informe_"+codTrato).val();
                let avDisp = data.avancedisp;
                $("#btnAddRebaje").removeAttr("disabled");
                if(data.medicion != "N"){
                    if(parseFloat(nAvance) && informe == "0")
                    avDisp -=parseFloat(nAvance);
                
                    avDisp = Math.round(avDisp * 100) / 100;
                    $("#lblAvanceDisp").html(avDisp);
                    $("#lblCantMax").html(avDisp);
                }
                else
                {
                    popover_err("txtITcodUnidad",data.tipoUnidad);                    
                    $("#txtITcodUnidad")
                    $("#lblAvanceDisp").html("-");
                    $("#btnAddRebaje").attr("disabled","disabled");
                }

                $("#txtITporcentaje").attr({"max" : data.avancedisp});
                $("#lblMsjeUnidad").show();

                if(data.medicion == "UNI")
                {
                    $("#spAvanceMax").show();
                    $("#spCantMax").hide();
                    $("#lblmsjDisp").html("Avance disponible:");
                    $("#txtITcantidad").val('1');
                    $("#txtITcantidad").prop("disabled",true);
                }
                else if(data.medicion == "CAN")
                {
                    $("#spAvanceMax").hide();
                    $("#spCantMax").show();
                    $("#lblmsjDisp").html("Cantidad disponible:");
                    $("#txtITporcentaje").val("100");
                    $("#txtITporcentaje").prop("disabled",true);
                }
                $("#msjeRebaje").html(data.msj);
                $("#unidadMedicion").val(data.medicion);
                $("#hValorTrato").val(data.valorTrato);
            })
            .catch(function(error){console.log(error);showToast('Error','Error','Ocurrió un error o no tiene autorización, comuniquese con Soporte.');});
        }      
        function removeTr(tr,id, org)
        {
            if($(tr).css("color") == "rgb(255, 0, 0)")
            {
                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                if(id > 0)
                {
                    if(org == "d"){
                        eliminar_detalle(id);
                    }
                    else if(org == "c")
                    {
                        eliminar_cuadrilla(id);
                    }
                }

                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                $(tr).parents("tr:first").remove();

            }{
                $(tr).css('color','red');
            }

           
        }
        function editTr(tr,med)
        {
            if(med=="UNI")
            {
                $(tr).parents("tr").find("input[class='form-control ea']").prop("disabled",false);
            }
            else if(med =="CUA")
            {
                $(tr).parents("tr").find("input[type='text']").prop("disabled",false);
            }
            else
            {
                $(tr).parents("tr").find("input[class='form-control ec']").prop("disabled",false);
            }
            
        }       
        
        function finalizar_informe(btn)
        {
            if($(btn).css("background-color") == "rgb(0, 128, 0)")
            {
                //finalizar IT
                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                let idInforme = $("#hIdInforme").val();
                if(idInforme != "")
                {
                    let rRebajes = $("#tbRebajeTrato tbody tr  input.dd");
                    let rCuadrilla = $("#tbCuadrillaTrato tbody tr input.dd");
                    if(rRebajes.length > 0 && rCuadrilla.length > 0)
                    {
                        let data = new FormData();
                        data.append('idInforme',idInforme);
                        data.append('csrfmiddlewaretoken',$("input[name=csrfmiddlewaretoken]").val());
                        fetchS("{% url 'informeTrabajo_finalizar' %}",{method:'POST',body: data})
                        .then((response) =>  response.json())
                        .then((data) => {
                            if(data.id != "")
                            {
                                if(data.idIt != "-1"){
                                    showToast("Exito","Informe Trabajo Finalizado","Informe de trabajo finalizado correctamente.");
                                    window.location = "{% url 'tratos' %}"
                                }
                                else
                                {
                                    showToast('Error','Error','El total de Rebajes debe ser el mismo que el total de la Cuadrilla.');
                                    $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                                }
                            }
                            else{
                                showToast('Error','Error','Ocurrió un error o no tiene autorización, comuniquese con Soporte.');
                                $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                            }
                        })
                        .catch(function(error){console.log(error);showToast('Error','Error','Ocurrió un error o no tiene autorización, comuniquese con Soporte.');});
                    }
                    else
                    {
                        showToast("Error","Error!","Informe de trabajo incompleto.");
                        $('#iboxTratos').children('.ibox-content').toggleClass('sk-loading');
                    }
                    
                }
            }{
                $(btn).css('background-color','green');
            }

           
        }        
        
        function popover_err(input,msje)
        {
            $("#"+input).attr("data-content",msje)
            $("#"+input).popover("show");
            $(".popover-body").css("background-color","red");
            $(".arrow").css("border-right-color","red!important");
            $(".popover-body").css("color","white");
        }

        $(document).ready(function(){
            $('[data-toggle="popover"]').popover(); 
            $(document).ready(function() {
                $('.chosen-select').chosen({
                    placeholder_text_multiple: 'Selecciona las unidades',
                    width: '100%'
                });
            });
        });
    </script>


    {% endif %}

{% endblock %}
